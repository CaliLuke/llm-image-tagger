============================= test session starts ==============================
platform darwin -- Python 3.11.11, pytest-8.0.0, pluggy-1.5.0 -- /Users/luca/Documents/Code/llm-image-tagger/venv/bin/python
cachedir: .pytest_cache
rootdir: /Users/luca/Documents/Code/llm-image-tagger
plugins: asyncio-0.23.5, anyio-4.9.0
asyncio: mode=Mode.STRICT
collecting ... collected 82 items

backend/tests/test_api.py::test_read_root PASSED                         [  1%]
backend/tests/test_api.py::test_folder_not_found PASSED                  [  2%]
backend/tests/test_api.py::test_search_no_folder PASSED                  [  3%]
backend/tests/test_api.py::test_process_image_not_found PASSED           [  4%]
backend/tests/test_api.py::test_update_metadata PASSED                   [  6%]
backend/tests/test_api.py::test_search_with_results_mocked PASSED        [  7%]
backend/tests/test_api.py::test_check_init_status PASSED                 [  8%]
backend/tests/test_api.py::test_stop_processing PASSED                   [  9%]
backend/tests/test_api.py::test_process_image_endpoint_mocked PASSED     [ 10%]
backend/tests/test_api.py::test_get_image_not_found PASSED               [ 12%]
backend/tests/test_api.py::test_get_image_invalid_format PASSED          [ 13%]
backend/tests/test_api.py::test_get_image_rgba PASSED                    [ 14%]
backend/tests/test_api.py::test_get_image_rgb PASSED                     [ 15%]
backend/tests/test_api.py::test_folder_reload_with_metadata PASSED       [ 17%]
backend/tests/test_api.py::test_directory_listing_direct PASSED          [ 18%]
backend/tests/test_api.py::test_directory_listing_no_folder_error FAILED [ 19%]
backend/tests/test_config.py::test_settings_defaults PASSED              [ 20%]
backend/tests/test_config.py::test_path_config_initialization PASSED     [ 21%]
backend/tests/test_config.py::test_normalize_path PASSED                 [ 23%]
backend/tests/test_config.py::test_path_safety PASSED                    [ 24%]
backend/tests/test_config.py::test_temp_directory_safety PASSED          [ 25%]
backend/tests/test_config.py::test_symlink_safety PASSED                 [ 26%]
backend/tests/test_config.py::test_relative_path_safety PASSED           [ 28%]
backend/tests/test_config.py::test_make_relative_to_root PASSED          [ 29%]
backend/tests/test_frontend_queue.py::test_frontend_queue SKIPPED (F...) [ 30%]
backend/tests/test_frontend_queue_manual.py::test_frontend_queue_manual SKIPPED [ 31%]
backend/tests/test_image_processor.py::test_image_description_model PASSED [ 32%]
backend/tests/test_image_processor.py::test_image_tags_model PASSED      [ 34%]
backend/tests/test_image_processor.py::test_image_text_model PASSED      [ 35%]
backend/tests/test_image_processor.py::test_vector_store_add_entry PASSED [ 36%]
backend/tests/test_image_processor.py::test_vector_store_update_entry PASSED [ 37%]
backend/tests/test_image_processor.py::test_vector_store_search PASSED   [ 39%]
backend/tests/test_image_processor.py::test_image_processor_initialization PASSED [ 40%]
backend/tests/test_image_processor.py::test_get_text_content PASSED      [ 41%]
backend/tests/test_image_processor.py::test_get_description PASSED       [ 42%]
backend/tests/test_image_processor.py::test_get_tags PASSED              [ 43%]
backend/tests/test_image_processor.py::test_process_image_full PASSED    [ 45%]
backend/tests/test_image_processor.py::test_process_image_no_text PASSED [ 46%]
backend/tests/test_image_processor.py::test_vector_store_sync_and_consistency PASSED [ 47%]
backend/tests/test_image_processor.py::test_vector_store_error_handling PASSED [ 48%]
backend/tests/test_image_processor_progress.py::test_query_ollama_progress_tracking PASSED [ 50%]
backend/tests/test_image_processor_progress.py::test_process_image_progress_updates PASSED [ 51%]
backend/tests/test_image_processor_progress.py::test_process_image_error_handling PASSED [ 52%]
backend/tests/test_image_processor_progress.py::test_ollama_streaming_error PASSED [ 53%]
backend/tests/test_process_image_paths.py::test_process_image_paths PASSED [ 54%]
backend/tests/test_queue_endpoints.py::test_queue_endpoints PASSED       [ 56%]
backend/tests/test_queue_persistence.py::test_queue_persistence_initialization PASSED [ 57%]
backend/tests/test_queue_persistence.py::test_save_and_load_empty_queue PASSED [ 58%]
backend/tests/test_queue_persistence.py::test_save_and_load_queue_with_tasks PASSED [ 59%]
backend/tests/test_queue_persistence.py::test_auto_save PASSED           [ 60%]
backend/tests/test_queue_persistence.py::test_recovery_from_interrupted_task PASSED [ 62%]
backend/tests/test_queue_persistence.py::test_clear_saved_state PASSED   [ 63%]
backend/tests/test_queue_persistence.py::test_queue_persistence_save_load PASSED [ 64%]
backend/tests/test_queue_persistence.py::test_queue_persistence_empty_state PASSED [ 65%]
backend/tests/test_queue_persistence.py::test_queue_persistence_invalid_data PASSED [ 67%]
backend/tests/test_queue_processing.py::test_queue_processing PASSED     [ 68%]
backend/tests/test_queue_processor.py::test_queue_processor_init PASSED  [ 69%]
backend/tests/test_queue_processor.py::test_process_queue PASSED         [ 70%]
backend/tests/test_queue_processor.py::test_process_queue_already_processing PASSED [ 71%]
backend/tests/test_queue_processor.py::test_stop_processing PASSED       [ 73%]
backend/tests/test_queue_processor.py::test_stop_processing_not_processing PASSED [ 74%]
backend/tests/test_queue_processor.py::test_process_task PASSED          [ 75%]
backend/tests/test_queue_processor.py::test_process_task_error PASSED    [ 76%]
backend/tests/test_queue_processor.py::test_process_task_stop_before PASSED [ 78%]
backend/tests/test_queue_processor.py::test_process_task_stop_after PASSED [ 79%]
backend/tests/test_queue_progress.py::test_progress_tracking PASSED      [ 80%]
backend/tests/test_queue_progress.py::test_progress_callback_in_queue_processor PASSED [ 81%]
backend/tests/test_queue_progress.py::test_progress_updates_during_queue_processing PASSED [ 82%]
backend/tests/test_queue_progress.py::test_progress_tracking_with_error PASSED [ 84%]
backend/tests/test_storage.py::test_read_existing_file PASSED            [ 85%]
backend/tests/test_storage.py::test_read_nonexistent_file PASSED         [ 86%]
backend/tests/test_storage.py::test_read_invalid_json PASSED             [ 87%]
backend/tests/test_storage.py::test_write_new_file PASSED                [ 89%]
backend/tests/test_storage.py::test_write_existing_file PASSED           [ 90%]
backend/tests/test_storage.py::test_write_permission_error PASSED        [ 91%]
backend/tests/test_storage.py::test_delete_existing_file PASSED          [ 92%]
backend/tests/test_storage.py::test_delete_nonexistent_file PASSED       [ 93%]
backend/tests/test_storage.py::test_exists PASSED                        [ 95%]
backend/tests/test_storage.py::test_atomic_write PASSED                  [ 96%]
backend/tests/test_storage.py::test_retry_logic PASSED                   [ 97%]
test_storage.py::test_storage SKIPPED (async def function and no asy...) [ 98%]
test_storage_nested.py::test_nested_storage SKIPPED (async def funct...) [100%]

=================================== FAILURES ===================================
____________________ test_directory_listing_no_folder_error ____________________

client = <starlette.testclient.TestClient object at 0x168e35ed0>

    @pytest.mark.asyncio
    async def test_directory_listing_no_folder_error(client):
        """Test the error case where no folder is selected."""
        # Make sure no folder is selected
        router.current_folder = None
        router.vector_store = None
    
        # Call the endpoint
        response = client.get("/directories")
    
        # Verify error response
>       assert response.status_code == 400
E       assert 200 == 400
E        +  where 200 = <Response [200 OK]>.status_code

backend/tests/test_api.py:901: AssertionError
---------------------------- Captured stdout setup -----------------------------
Initializing new ProcessingQueue
Initializing new ProcessingQueue
------------------------------ Captured log setup ------------------------------
INFO     tests.conftest:conftest.py:31 Setting up test environment
----------------------------- Captured stdout call -----------------------------
Listing directories in current folder: /Users/luca/Documents/Code/llm-image-tagger/test_data/test_images
Listing directories in current folder: /Users/luca/Documents/Code/llm-image-tagger/test_data/test_images
Found 5 directories in /Users/luca/Documents/Code/llm-image-tagger/test_data/test_images
Found 5 directories in /Users/luca/Documents/Code/llm-image-tagger/test_data/test_images
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1038 HTTP Request: GET http://testserver/directories "HTTP/1.1 200 OK"
---------------------------- Captured log teardown -----------------------------
INFO     tests.conftest:conftest.py:47 Cleaning up test environment
INFO     tests.conftest:conftest.py:55 Test environment cleanup complete
=============================== warnings summary ===============================
test_storage.py::test_storage
test_storage_nested.py::test_nested_storage
  /Users/luca/Documents/Code/llm-image-tagger/venv/lib/python3.11/site-packages/_pytest/python.py:182: PytestUnhandledCoroutineWarning: async def functions are not natively supported and have been skipped.
  You need to install a suitable plugin for your async framework, for example:
    - anyio
    - pytest-asyncio
    - pytest-tornasync
    - pytest-trio
    - pytest-twisted
    warnings.warn(PytestUnhandledCoroutineWarning(msg.format(nodeid)))

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED backend/tests/test_api.py::test_directory_listing_no_folder_error - as...
============= 1 failed, 77 passed, 4 skipped, 2 warnings in 9.08s ==============
Log cleanup complete. Removed entries older than 2025-03-23
Log cleanup complete. Removed entries older than 2025-03-23
Running tests...
